% Draw something looking like a git network.
% Only 2 parallel git chains supported now.

\tikzmath{
  \CommitRadius = 3;
  \CommitScale = 2.0;
  \CommitMargins = 5;
  \CommitBaseHeight = -2;
  \CommitSpacing = 11;
  \BranchesSpacing = 8;
  \LabelIsep = 2;
  \CommitArrowShorten = \CommitRadius + 2;
  \LabelArrowShorten = \CommitRadius + 2;
  \CommandScale = 4;
  \CommandPad = 2;
}
\tikzset{
  commit/.style={line width=2.0, fill=Orange3, draw=Dark3},
  hash/.style={Light5},
  commit arrow/.style={-{Straight Barb[angle'=70, length=3mm]},
                       Light5, line width=4.5,
                       shorten >=\CommitArrowShorten mm,
                       shorten <=\CommitArrowShorten mm,
                       },
  label/.style={line width=1.5, draw, #1, fill=Light3, scale=\CommitScale,
                inner sep=\LabelIsep, rounded corners, -Stealth},
  label-hi/.style={label=#1, fill=Yellow1},
  %
  repo label/.style={scale=\NormalScale, inner sep=2, draw, Dark3, fill=Light2},
  remote label/.style={repo label, Blue4, fill=Light2},
  %
  remote pointer/.style={-Stealth, line width=2, Brown2, dashed},
  remote flow/.style={remote pointer, solid, line width=20},
  remote arrow label/.style={scale=\NormalScale, above=2, sloped,
                       draw, solid, inner sep = 2},
  remote arrow label-hi/.style={remote arrow label, fill=Yellow1},
  %
  command text/.style={scale=\CommandScale, Dark4},
  command box/.style={draw=Dark3, fill=Light4, line width=2.5},
}

% Draw one commit with hash and message, use [offset] to align with 2 branches.
% [name][hash-offset][messa-offset]{location}{hash}{message}
\NewDocumentCommand{\Commit}{ O{commit-center} O{0} O{0} m m m }{

  \coordinate[alias=\LatestRepo-#1] (#1) at (#4);
  \path[commit] (#1) circle (\CommitRadius);

  % Hash.
  \node[scale=\CommitScale, anchor=base east, hash,
        alias=\LatestRepo-#5-hash] (#5-hash)
    at ($(#1) - (\CommitRadius + \CommitMargins + #2, -\CommitBaseHeight)$)
    {\tt #5};

  % Message.
  \node[scale=\CommitScale, anchor=base west, Dark4,
        alias=\LatestRepo-#5-message] (#5-message)
    at ($(#1) + (\CommitRadius + \CommitMargins - #2 + #3, \CommitBaseHeight)$)
    {\tt #6};

}

% Chain commits together.
% [anchor][reponame][simple|double]{location}{type/hash/message list}
\NewDocumentCommand{\Repo}{ O{center} O{repo} O{simple} m m }{

  % Update this global variable so commits, branches etc.
  % can be aliased with (reponame-name) in addition to (name).
  \def\LatestRepo{#2}

  \IntensiveCoordinates{Canvas}{loc}{#4}
  \node[anchor=#1] (#2) at (loc) {\tikz[remember picture]{
    \def\merged{1} % Lower when there are two chains.
    % Vertical/Horizontal commit spacing.
    \tikzmath{
      \V = 2*\CommitRadius + \CommitSpacing;
      \H = \BranchesSpacing;
      \Hoff = 0;
    }
    % All messages need to be offset by 1 unit if the repo is double
    % so they remain aligned.
    \ifstrequal{#3}{double}{\tikzmath{ \Hoff = \H; }}{}
    \foreach \type/\hash/\message [count=\i] in {#5} {\ifcsempty{hash}{}{
      \ifnumcomp{\i}{=}{1}{
        \Commit[\hash][0][\Hoff]{0, 0}{\hash}{\message}
        % Keep track of last commit on the straight/parallel chain..
        \coordinate (straight) at (\hash);
        \coordinate (parallel) at (\hash); % (but they start merged)
        \coordinate (last) at (\hash); % .. and of last commit at all.
      }{
        \coordinate (\hash) at ($(straight |- last) + (\H, \V)$);
        % Commit position depends on its type.
        % I: commit on the straight chain.
        % Y: fork commit (the first on the parallel chain).
        % H: commit on the parallel chain.
        % A: merge commit (on the straight chain).
        \ifdefstring{\type}{Y}{
          \coordinate (parallel) at (straight);
        }{}
        \ifboolexpr{ test {\ifdefstring{\type}{H}}
                  or test {\ifdefstring{\type}{Y}} }{
          \ifdefstring{\merged}{1}{
            \draw[commit arrow] (parallel) -- (\hash);
          }{
            \coordinate
              [above=\CommitRadius + .5*\CommitSpacing of parallel] (c);
            \draw[commit arrow] (parallel) .. controls (\hash |- c) .. (\hash);
          }
          \coordinate (parallel) at (\hash);
          \def\merged{0}
        }{
          \coordinate (\hash) at (straight |- \hash);
          \draw[commit arrow] (straight) -- (\hash);
          \coordinate (straight) at (\hash);
          \tikzmath{ \H = 0; }
        }
        \Commit[\hash][\H][\Hoff]{\hash}{\hash}{\message}
        \ifdefstring{\type}{A}{%
          \coordinate[below=\CommitRadius + .5*\CommitSpacing of \hash] (c);
          \draw[commit arrow] (parallel)
                  .. controls (parallel |- c) .. (\hash);
          \coordinate (straight) at (\hash);
          \coordinate (parallel) at (\hash);
          \def\merged{1}
        }{}
    }
    \coordinate (last) at (\hash);
  }}}};

}

% Pick a commit and point label to it.
% If 'base' appears in the ref,
% it is assumed that horizontal alignment is needed,
% so the local arrow 'start' is interpreted
% as an absolute vertical offset from the base,
% the reference end destination is given the same offset,
% and the arrow is not shortened.
% (Useful when eg. HEAD is pointing to a branch.)
% If local arrow start is 'noarrow', there is no pointer.
% (Useful on empty repos or to stick origin/main to main.)
% [name][anchor][style]{ref}{offset}{start}{text}
\NewDocumentCommand{\Label}{ O{unnamed} O{base} O{label} m m m m }{

  \IfSubStr{#4}{base}{\IfSubStr{#4}{west}
   {\coordinate[left=#5 of #4] (c);}
   {\coordinate[right=#5 of #4] (c);}}
   {\coordinate (c) at ($(#4) + (#5)$);}

  \node[#3, anchor=#2, alias=\LatestRepo-#1] (#1) at (c) {\tt #7};

  \IfSubStr{#3}{-hi}{
    \coordinate (pad) at (1, 1);
    \coordinate (lo) at ($(#1.south west) - (pad)$);
    \coordinate (up) at ($(#1.north east) + (pad)$);
    \draw[Yellow1, line width=4] (lo) rectangle (up);
  }{}

  \ifstrequal{#6}{noarrow}{}{
    \begin{pgfonlayer}{background}
      \IfSubStr{#4}{base}{
        % Assume we're pointing to another label, horizontally.
        \IfSubStr{#4}{west}{
          \coordinate (s) at ($(#1.base east) + (-1, #6)$);
        }{
          \coordinate (s) at ($(#1.base west) + (+1, #6)$);
        }
        \coordinate[above=#6 of #4] (e);
        \draw[#3, shorten >=0] (s) -- (e);
      }{
        % Assume we're pointing to a commit.
        \begin{scope}[local to=#1]
          \coordinate (s) at (#6);
        \end{scope}
        \draw[#3, shorten >=\CommitArrowShorten mm] (s) -- (#4);
      }
    \end{pgfonlayer}
  }

}
% Basic branch label.
% [anchor][style]{ref}{offset}{start}{name}
\NewDocumentCommand{\Branch}{ O{base} O{label} m m m m }{
  \Label[#6][#1][#2=Blue4]{#3}{#4}{#5}{#6}
}
% Remote branch label.
% [anchor][style]{ref}{offset}{start}{name}
\NewDocumentCommand{\RemoteBranch}{ O{base} O{label} m m m m }{
  \Label[#6][#1][#2=Brown2]{#3}{#4}{#5}{#6}
}
% HEAD label.
% [anchor][style]{ref}{offset}{start}
\NewDocumentCommand{\Head}{ O{base} O{label} m m m }{
  \Label[HEAD][#1][#2=Purple4]{#3}{#4}{#5}{HEAD}
}
% Highlight current commit (ref must be a hash).
% {ref}
\newcommand{\HighlightCommit}[1]{
  \fill[Yellow1] (#1) circle (.9*\CommitRadius);
}

% {anchor}{location}{label}
\newcommand{\LocalRepoLabel}[3]{%
  \IntensiveCoordinates{Canvas}{c}{#2}
  \node[repo label, anchor=#1] at (c) {\textit{#3}};
}
\newcommand{\UrlHighlight}[1]{%
  \tikz[baseline={(n.base)},inner sep=.5]{\node[fill=Yellow1](n){#1};}%
}
% [highlight]{anchor}{location}{account}{name}
\NewDocumentCommand{\RemoteRepoLabel}{ O{} m m m m }{{%
  \def\account{\IfSubStr{#1}{account}{\UrlHighlight{#4}}{#4}}
  \def\name   {\IfSubStr{#1}{name}{\UrlHighlight{#5}}{#5}}
  \AutomaticCoordinates{c}{#3}
  \node[remote label, anchor=#2] at (c) {\tt https://github.com/\account/\name};
}}


% Arrow from one repo to another.
% [name][bend][side][highlight]{start}{end}
\NewDocumentCommand{\RemoteArrow}{ O{} O{0} O{left} O{} m m }{
  \AutomaticCoordinates{s}{#5}
  \AutomaticCoordinates{e}{#6}
  \ifstrequal{#1}{}{
    \begin{scope}[transparency group, opacity=.5]
      \draw[remote flow] (s) to[bend #3=#2] (e);
    \end{scope}
  }{
    \draw[remote pointer] (s) to[bend #3=#2]
      node[remote arrow label#4] {\tt #1} (e);
  }
}

% Display the command used.
% If 'start' is given, make it like a cartoon bubble,
% pointing to intensive horizontal coordinate 'end'.
% [anchor][start][end][aperture]{location}{text}
\NewDocumentCommand{\Command}{ O{base} O{} O{.5} O{5} m m }{
  \AutomaticCoordinates{c}{#5}
  \node[command text, anchor=#1] (command) at (c) {\tt \$ #6};
  \coordinate (pad) at (\CommandPad, \CommandPad);
  \coordinate (low) at ($(command.south west) - (pad)$);
  \coordinate (up) at ($(command.north east) + (pad)$);
  \begin{pgfonlayer}{background}
    \ifstrequal{#2}{}{
      \path[command box] (low) rectangle (up);
    }{
      \AutomaticCoordinates{s}{#2}
      \coordinate (e) at ($(command.west)!#3!(command.east)$);
      \tikzmath{
        coordinate \comm, \start;
        \comm = (c);
        \start = (s);
        \IsStartHigher = \starty > \commy;
      }
      \ifdefstring{\IsStartHigher}{1}{\def\corner{up}}{\def\corner{low}}
      \coordinate (p) at (e |- \corner);
      \coordinate[left=.5*#4 of p] (e1);
      \coordinate[right=.5*#4 of p] (e2);
      \ifdefstring{\IsStartHigher}{1}{
        \path[command box]
          (s) -- (e1) -- (low |- up) --
          (low) -- (low -| up) -- (up) -- (e2) -- cycle;
      }{
        \path[command box]
          (s) -- (e1) -- (low) --
          (low |- up) -- (up) -- (up |- low) -- (e2) -- cycle;
      }
    }
  \end{pgfonlayer}
}
