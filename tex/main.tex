\documentclass[multi=step]{standalone}

% The idea here, for now,
% is to construct a framework flexible enough
% to easily draw the various states of the files/tree/history,
% so it becomes easier to animate afterwards.
% This file will be typically (re-)generated from some other script.

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{mathptmx}
\usepackage[T1]{fontenc}

\usepackage{xkeyval}
\usepackage{etoolbox}
\usepackage{tikz}%
  \usetikzlibrary{math}
  \usetikzlibrary{positioning}
  \usetikzlibrary{calc}
  \usetikzlibrary{arrows.meta}
\tikzset{
  x=1mm,
  y=1mm,
  inner sep=0,
  file tree line/.style={line width=1.5, line cap=round},
  % https://tex.stackexchange.com/a/447931/72679
  local to/.style={
      shift={(#1.center)},
      x={(#1.east)},
      y={(#1.north)},
  }
}
% Define a point wrt to existing node with relative coordinates.
\NewDocumentCommand{\IntensiveCoordinates}{ m m m }{
  \begin{scope}[local to=#1]
    \coordinate (#2) at (#3);
  \end{scope}
}

\tikzmath{
  \eps = 0.1; % Useful to avoid seemingly pixel-rounding errors.
}

\usepackage{graphicx}
\usepackage{xsavebox}
\graphicspath{{./pictures}}

\foreach \bx/\filename in {
  GitLogo/git_logo.png,
  GithubLogo/github_logo.png,
  GitlabLogo/gitlab_logo.png,
  RStudioExtension/rstudio_extension.png,
  ConsoleGit/console_git.png,
  VSCodeExtension/vscode_extension.png,
  VariousPizzas/pizzas_various.jpg,
  Margherita/margherita.png,
  Regina/regina.jpg,
  MyMachine/my_machine.png,
  TheirMachine/their_machine.png,
  PullRequestButton/pull_request_button.jpg,
  SyncForkButton/sync_fork_button.png
}{%
  \xsavebox{\bx}{\includegraphics[width=1cm]{\filename}}
  \expandafter\xdef\csname Pic\bx\endcsname##1##2%
    {\resizebox{##1}{##2}{\xusebox{\bx}}}
}

\input{palette}
\input{step}
\input{files}
\input{diff}
\input{repo}
\input{command}

\newcommand{\TitleText}{<no-title>}
\newcommand{\SubTitleText}{<no-subtitle>}
\newcommand{\PageNumText}{<no-page-number>}
\newcommand{\Progress}{0/1}

\begin{document}%

% Use SLIDE marks for python to easily find all slides.
% Also, this file is parsed lexically in a very brutal way,
% so whitespace and comments are not always insignificant.
% Just use it as a stub so python scripts can bootstrap and generate steps.

% SLIDE Clients
\renewcommand{\TitleText}{Introduction}
\renewcommand{\SubTitleText}{Git and git clients}
\renewcommand{\PageNumText}{1}
\renewcommand{\Progress}{1/4}
\newlength{\U}
\Step{
  \begin{scope}[inner sep=10]
    \setlength{\U}{75mm}
    \tikzmath{
      \boffset = -5;
    }

    \node[anchor=north, below=5 of Canvas.north] (git)
      {\PicGitLogo{\U}{!}};

    \node[anchor=north, below=20 of git] (console)
      {\PicConsoleGit{!}{\U}};
    \node[below=\boffset of console, scale=\LargeScale]
      {command-line console};

    \node[anchor=east, left=30 of console] (vscode)
      {\PicVSCodeExtension{!}{\U}};
    \node[below=\boffset of vscode, scale=\LargeScale]
      {VSCode extension};

    \node[anchor=west, right=30 of console] (rstudio)
      {\PicRStudioExtension{!}{\U}};
    \node[below=\boffset of rstudio, scale=\LargeScale]
      {RStudio extension};

    \coordinate (tp) at ($(vscode)!.5!(console)$);
    \node[anchor=north, below=65 of tp] (github)
      {\PicGithubLogo{1.5\U}{!}};

    \coordinate (tp) at ($(console)!.5!(rstudio)$);
    \node[anchor=north] (gitlab) at (github -| tp)
      {\PicGitlabLogo{1.5\U}{!}};

    \begin{scope}[every path/.style={-Stealth, line width=2, Dark4}]
      \draw (vscode.north) -- (git.west);
      \draw (console.north) -- (git.south);
      \draw (rstudio.north) -- (git.east);
      \draw (github.north) .. controls +(0, 100) .. (git.south west);
      \draw (gitlab.north) .. controls +(0, 130) .. (git.south east);
    \end{scope}

    \HighlightShade{git}

  \end{scope}
} % ENDSLIDE

% SLIDE Pizzas
\renewcommand{\TitleText}{The Pizzas repo}
\renewcommand{\SubTitleText}{Crafting your first commits}
\renewcommand{\PageNumText}{2}
\renewcommand{\Progress}{2/4}
\Step{

  \IntensiveCoordinates{Canvas}{A}{-1, 1}
  \FirstFile[folder, mod=0]{A}{A}{rootfolder}

  \IntensiveCoordinates{Canvas}{A}{1, 1}
  \def\FileSpacing{8}
  \Diff[m][north east][A]{A}{file.ext}{
    +/{One line},
  }
  \Diff[0][north east][A]{$(A.south east) + (0, -\FileSpacing)$}{other.ext}{
    -/{Another line.},
  }

  \Repo[south west]{Canvas.south west}{
    I/hash256/{Commit message.},
  }%
  \Branch[Blue4][base][label]{hash256}{40:20}{-.5,0}{branch}
  \Head[base][label]{hash256}{155:20}{.5,0}

  \Command[base]{0, 0}{git init}

} % ENDSLIDE

% SLIDE Remote
\renewcommand{\TitleText}{Collaborating}
\renewcommand{\SubTitleText}{Working with a remote}
\renewcommand{\PageNumText}{3}
\renewcommand{\Progress}{3/4}%
\Step{

  \IntensiveCoordinates{Canvas}{A}{-1, 1}
  \FirstFile[folder, mod=0]{A}{A}{root}

  \IntensiveCoordinates{Canvas}{B}{.7, 1}
  \FirstFile[folder, mod=0]{B}{B}{root}

  \IntensiveCoordinates{Canvas}{c}{1, .85}
  \Diff[m][north east][A]{c}{file.ext}{
    +/{One line},
  }

  \begin{scope}[local to=Canvas]
    \node[opacity=.2] (github) at (0, .5) {\PicGithubLogo{10cm}{!}};
    \node[opacity=.2] (mymachine) at (-.7, -.6) {\PicMyMachine{75mm}{!}};
    \node[opacity=.2] (mymachine) at (+.7, -.6) {\PicTheirMachine{75mm}{!}};
  \end{scope}

  \Repo[south west][mine][double]{-1, -1}{
  }%
  \LocalRepoLabel{base west}{Canvas.west}{my machine}


  \Repo[base][remote][double]{.1, .1}{
  }%
  \RemoteRepoLabel{north}{.0, 1}{MyAccount}


  \Repo[base][theirs][double]{.65, -1}{
  }%
  \LocalRepoLabel{base east}{Canvas.east}{their machine}

  \IntensiveCoordinates{Canvas}{start}{-.8, -.1}
  \IntensiveCoordinates{Canvas}{end}{-.2, .6}
  \RemoteArrow[left][40]{start}{end}

  \Command[center]{-.7, +.3}{git push}
  \Command[center]{+.7, +.3}{git fetch}


} % ENDSLIDE

% SLIDE Fork
\renewcommand{\TitleText}{Collaborating}
\renewcommand{\SubTitleText}{Working with a fork}
\renewcommand{\PageNumText}{4}
\renewcommand{\Progress}{4/4}
\Step{

  \IntensiveCoordinates{Canvas}{A}{-1, 1}
  \FirstFile[folder, mod=0]{A}{A}{root}

  \IntensiveCoordinates{Canvas}{c}{1, .85}
  \Diff[m][north east][A]{c}{file.ext}{
    +/{One line},
  }

  \begin{scope}[local to=Canvas]
    \foreach \xy in {{-.4,.5},{.4,.5}}{%
      \node[opacity=.2] (github) at (\xy) {\PicGithubLogo{10cm}{!}};
    }
    \foreach \xy/\Pic in {{-.7,-.6}/MyMachine,
                           { .7,-.6}/TheirMachine}{%
      \node[opacity=.2] (github) at (\xy) {\csname Pic\Pic\endcsname{75mm}{!}};
    }
  \end{scope}

  \Repo[south west][mine][double]{-1, -1}{
    I/hash256/{Commit message.},
    H/075f8fc/{Divergent commit.},
    H/f6b005f/{Second branch commit.},
    A/d9c4395/{Merge commit.},
    I/58d8fe0/{Merge commit.},
    I/58d8fe0/{Merge commit.},
  }%
  \LocalRepoLabel{base west}{-1, -.15}{my machine}
  \Branch[Blue4][base][label]{58d8fe0}{25:20}{-.5,0}{main}
  \Head[base][label]{58d8fe0}{155:20}{.5,0}


  \Repo[base west][hub][double]{-.75, .1}{
    I/hash256/{Commit message.},
    H/075f8fc/{Divergent commit.},
    H/f6b005f/{Second branch commit.},
    A/d9c4395/{Merge commit.},
    I/58d8fe0/{Merge commit.},
    I/58d8fe0/{Merge commit.},
  }%
  \RemoteRepoLabel{north}{-.40, 1}{MyAccount}
  \Branch[Blue4][base][label]{58d8fe0}{25:20}{-.5,0}{main}
  \Head[base][label]{58d8fe0}{155:20}{.5,0}


  \Repo[base east][fork][double]{.75, .1}{
    I/hash256/{Commit message.},
    H/075f8fc/{Divergent commit.},
    H/f6b005f/{Second branch commit.},
    A/d9c4395/{Merge commit.},
    I/58d8fe0/{Merge commit.},
    I/58d8fe0/{Merge commit.},
  }%
  \RemoteRepoLabel{north}{.40, 1}{TheirAccount}
  \Branch[Blue4][base][label]{58d8fe0}{25:20}{-.5,0}{main}
  \Head[base][label]{58d8fe0}{155:20}{.5,0}

  \Repo[base][theirs][double]{.65, -1}{
    I/hash256/{Commit message.},
    H/075f8fc/{Divergent commit.},
    H/f6b005f/{Second branch commit.},
    A/d9c4395/{Merge commit.},
    I/58d8fe0/{Merge commit.},
    I/58d8fe0/{Merge commit.},
  }%
  \LocalRepoLabel{base east}{1, -.15}{their machine}
  \Branch[Blue4][base][label]{58d8fe0}{25:20}{-.5,0}{main}
  \Head[base][label]{58d8fe0}{155:20}{.5,0}

  \Command[center]{-.5, -.1}{git push}
  \Command[center]{+.5, -.1}{git fetch}
  \Command[center]{-.05, +.5}{git fetch}

  \IntensiveCoordinates{Canvas}{start}{-.5, .5}
  \IntensiveCoordinates{Canvas}{end}{.4, .5}
  \RemoteArrow[left][50]{start}{end}

  \node[below=5 of command, draw=Blue4, line width=7]
    {\PicSyncForkButton{!}{15mm}};

} % ENDSLIDE

\end{document}

