\documentclass[multi=step]{standalone}

% The idea here, for now,
% is to construct a framework flexible enough
% to easily draw the various states of the files/tree/history,
% so it becomes easier to animate afterwards.
% This file will be typically (re-)generated from some other script.

\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{mathptmx}
\usepackage[T1]{fontenc}

\usepackage{xstring}
\usepackage{xkeyval}
\usepackage{etoolbox}
\usepackage{tikz}%
  \usetikzlibrary{math}
  \usetikzlibrary{positioning}
  \usetikzlibrary{calc}
  \usetikzlibrary{arrows.meta}
  \usetikzlibrary{intersections}
\tikzset{
  x=1mm,
  y=1mm,
  inner sep=0,
  % https://tex.stackexchange.com/a/447931/72679
  local to/.style={
      shift={(#1.center)},
      x={(#1.east)},
      y={(#1.north)},
  }
}
% Define a point wrt to existing node with relative coordinates.
% {node}{name}{location}
\newcommand{\IntensiveCoordinates}[3]{
  \begin{scope}[local to=#1]
    \coordinate (#2) at (#3);
  \end{scope}
}

\tikzmath{
  \eps = 0.1; % Useful to avoid seemingly pixel-rounding errors.
}

\usepackage{graphicx}
\usepackage{xsavebox}
\graphicspath{{./pictures}}

\foreach \bx/\filename in {
  GitLogo/git_logo.png,
  GithubLogo/github_logo.png,
  GitlabLogo/gitlab_logo.png,
  RStudioExtension/rstudio_extension.png,
  ConsoleGit/console_git.png,
  VSCodeExtension/vscode_extension.png,
  VariousPizzas/pizzas_various.jpg,
  Margherita/margherita.png,
  Regina/regina.jpg,
  Diavola/diavola.jpg,
  Capricciosa/capricciosa.png,
  Calzone/calzone.png,
  Marinara/marinara.jpg,
  OMG/omg.png,
  NowWhat/now_what.jpeg,
  MyMachine/my_machine.png,
  TheirMachine/their_machine.png,
  PullRequestButton/pull_request_button.jpg,
  SyncForkButton/sync_fork_button.png
}{%
  \xsavebox{\bx}{\includegraphics[width=1cm]{\filename}}
  \expandafter\xdef\csname Pic\bx\endcsname##1##2%
    {\resizebox{##1}{##2}{\xusebox{\bx}}}
}

\input{palette}
\input{step}
\input{files}
\input{diff}
\input{repo}

\newcommand{\TitleText}{<no-title>}
\newcommand{\SubTitleText}{<no-subtitle>}
\newcommand{\PageNumText}{<no-page-number>}
\newcommand{\Progress}{0/1}

\begin{document}%

% Use SLIDE marks for python to easily find all slides.
% Also, this file is parsed lexically in a very brutal way,
% so whitespace and comments are not always insignificant.
% Just use it as a stub so python scripts can bootstrap and generate steps.

% SLIDE Clients
\renewcommand{\TitleText}{Introduction}
\renewcommand{\SubTitleText}{Git and git clients}
\renewcommand{\PageNumText}{1}
\renewcommand{\Progress}{1/4}
\newlength{\U}
\Step{
  \begin{scope}[inner sep=10]
    \setlength{\U}{75mm}
    \tikzmath{
      \boffset = -5;
    }

    \node[anchor=north, below=5 of Canvas.north] (git)
      {\PicGitLogo{\U}{!}};

    \node[anchor=north, below=20 of git] (console)
      {\PicConsoleGit{!}{\U}};
    \node[below=\boffset of console, scale=\LargeScale]
      {command-line console};

    \node[anchor=east, left=30 of console] (vscode)
      {\PicVSCodeExtension{!}{\U}};
    \node[below=\boffset of vscode, scale=\LargeScale]
      {VSCode extension};

    \node[anchor=west, right=30 of console] (rstudio)
      {\PicRStudioExtension{!}{\U}};
    \node[below=\boffset of rstudio, scale=\LargeScale]
      {RStudio extension};

    \coordinate (tp) at ($(vscode)!.5!(console)$);
    \node[anchor=north, below=65 of tp] (github)
      {\PicGithubLogo{1.5\U}{!}};

    \coordinate (tp) at ($(console)!.5!(rstudio)$);
    \node[anchor=north] (gitlab) at (github -| tp)
      {\PicGitlabLogo{1.5\U}{!}};

    \begin{scope}[every path/.style={-Stealth, line width=2, Dark4}]
      \draw (vscode.north) -- (git.west);
      \draw (console.north) -- (git.south);
      \draw (rstudio.north) -- (git.east);
      \draw (github.north) .. controls +(0, 100) .. (git.south west);
      \draw (gitlab.north) .. controls +(0, 130) .. (git.south east);
    \end{scope}

    \HighlightShade{git}

  \end{scope}
} % ENDSLIDE

% SLIDE Pizzas
\renewcommand{\TitleText}{The Pizzas repo}
\renewcommand{\SubTitleText}{Crafting your first commits}
\renewcommand{\PageNumText}{2}
\renewcommand{\Progress}{2/4}
\Step{

  \FileTree[north west][files]{-1, 1}{
    folder/+/root/rootfolder,
  }

  \Diff[m][north east][diff][5]{1, 1}{file.ext}{
    +/{One line},
  }

  \Repo[south west][repo][simple][1]{Canvas.south west}{}{}

  \Command[base][][.5][5][]{0, 0}{git init}

} % ENDSLIDE

% SLIDE Remote
\renewcommand{\TitleText}{Collaborating}
\renewcommand{\SubTitleText}{Working with a remote}
\renewcommand{\PageNumText}{3}
\renewcommand{\Progress}{3/4}
\Step{

  \FileTree[north west][myfiles]{-1, 1}{
    folder/+/root/rootfolder,
  }

  \FileTree[north west][theirfiles]{-1, 1}{
    folder/+/root/rootfolder,
  }

  \begin{scope}[local to=Canvas]\begin{pgfonlayer}{background}
    \node[opacity=.15] (github) at (0, .5) {\PicGithubLogo{10cm}{!}};
    \node[opacity=.15] (mymachine) at (-.7, -.6) {\PicMyMachine{75mm}{!}};
    \node[opacity=.15] (theirmachine) at (+.7, -.6) {\PicTheirMachine{75mm}{!}};
  \end{pgfonlayer}\end{scope}

  \Repo[south west][mine][mixed][1]{-1, -1}{}{}


  \Repo[base][remote][mixed][1]{.1, .08}{}{}


  \Repo[base][theirs][mixed][1]{.55, -1}{}{}

} % ENDSLIDE

% SLIDE Conflicts
\renewcommand{\TitleText}{Resolving Conflicts}
\renewcommand{\SubTitleText}{What a ``conflict'' means}
\renewcommand{\PageNumText}{4}
\renewcommand{\Progress}{4/4}
\Step{

\AutomaticCoordinates{low}{-.35, -.95}
\AutomaticCoordinates{up}{+.35, +.95}
\AutomaticCoordinates{lexical}{0, -.1}
\AutomaticCoordinates{semantic}{0, .3}

\path[fill=Blue1, draw=Blue3, line width=2] (low) rectangle (up);

\coordinate (mid) at ($(up)!.5!(low)$);
\coordinate (bottom) at (low-|mid);

\path[fill=Brown1, draw=Brown3, line width=2, fill opacity=0.5]
  (lexical) ellipse (63 and 70);

\path[fill=Purple1, draw=Purple3, line width=2, fill opacity=0.5]
  (semantic) ellipse (63 and 70);

\node[scale=\LargeScale, anchor=south, above=27 of bottom] (line) {no conflicts};
\node[below=3 of line, scale=\LargeScale] (line) {\it (happy zone)};
\node[below=1 of line, scale=\LargeScale, Green5] (line) {\rotatebox{-90}{\tt :)}};

\node[below=25 of lexical, scale=\LargeScale] (line) {\bf lexical conflicts};
\node[below=3 of line, scale=\LargeScale] (line) {\tt >> git conflicts <<};
\node[below=1 of line, scale=\LargeScale, Red4] (line) {\rotatebox{-90}{\tt :(}};

\node[above=44 of semantic, scale=\LargeScale] (line) {\bf semantic conflicts};
\node[below=3 of line, scale=\LargeScale] (line) {\tt >> git sees not <<};
\node[below=-2 of line, scale=\LargeScale, Red4] (line) {\rotatebox{-90}{\tt :(}};

\node[scale=\LargeScale] at ($(lexical)!.6!(semantic)$) (line) {\tt >> git catches you <<};
\node[below=3 of line, scale=\LargeScale] (line) {\it (happy zone)};
\node[below=1 of line, scale=\LargeScale, Green5] (line) {\rotatebox{-90}{\tt :)}};

\Diff[m][west][left][8]{-1, .5}{MY\_VERSION}{
  0/{my line},
}

\Diff[m][east][right][8]{1, .5}{THEIR\_VERSION}{
  0/{their line},
}

\Diff[0][north][merge][8]{$(left.north)!.5!(right.north)$}{MERGED\_VERSION}{
  0/{merged line},
}

} % ENDSLIDE

\end{document}

